<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Ap√©ro Quiz ‚Äì Joueur</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- iPhone : mode pseudo appli -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="Ap√©ro Quiz">

  <style>
    body {
      background: #020617;
      color: white;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      padding: 20px;
      margin: 0;
    }

    #card {
      max-width: 420px;
      margin: 0 auto;
      background: #0f172a;
      padding: 20px;
      border-radius: 18px;
      border: 1px solid #1e293b;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.6);
    }

    h2 {
      margin-top: 0;
      text-align: center;
      font-size: 1.5rem;
    }

    #nameInput, #openInput {
      width: 100%;
      padding: 12px;
      border-radius: 12px;
      border: none;
      margin-bottom: 10px;
      font-size: 1rem;
    }

    button {
      width: 100%;
      padding: 12px;
      border-radius: 999px;
      border: none;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      margin-bottom: 10px;
      background: #22c55e;
      color: #022c22;
    }

    button:active {
      transform: translateY(1px);
    }

    #timer {
      text-align: center;
      font-size: 2rem;
      margin-bottom: 12px;
      font-weight: 800;
    }

    #instruction {
      text-align: center;
      margin-bottom: 12px;
      color: #cbd5f5;
      font-size: 0.95rem;
    }

    #status {
      text-align: center;
      color: #a5b4fc;
      margin-top: 10px;
      min-height: 1.2em;
    }

    .opt-btn {
      width: 100%;
      padding: 12px;
      margin-bottom: 8px;
      border-radius: 14px;
      background: #1e293b;
      color: white;
      border: none;
      text-align: left;
      font-size: 1rem;
    }

    .opt-btn:active {
      background: #22c55e;
      color: #022c22;
    }
  </style>
</head>
<body>
  <div id="card">

    <!-- INSCRIPTION -->
    <div id="joinArea">
      <h2>Rejoindre le Quiz</h2>
      <input id="nameInput" placeholder="Ton pr√©nom" autocomplete="off" />
      <button id="joinBtn">Rejoindre</button>
    </div>

    <!-- JEU -->
    <div id="gameArea" style="display:none;">
      <div id="timer">00:00</div>

      <!-- On NE montre PAS la question ici -->
      <div id="instruction">
        üëÄ Regarde l'√©cran g√©ant<br>
        ‚úçÔ∏è R√©ponds ici sur ton t√©l√©phone
      </div>

      <!-- QCM -->
      <div id="options"></div>

      <!-- R√©ponse ouverte -->
      <div id="openArea" style="display:none;">
        <input id="openInput" placeholder="Tape ta r√©ponse‚Ä¶" autocomplete="off" />
        <button id="sendOpenBtn">Envoyer</button>
      </div>

      <div id="status"></div>
    </div>

  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    const joinArea = document.getElementById("joinArea");
    const gameArea = document.getElementById("gameArea");
    const nameInput = document.getElementById("nameInput");
    const joinBtn = document.getElementById("joinBtn");

    const timerEl = document.getElementById("timer");
    const optionsEl = document.getElementById("options");
    const openArea = document.getElementById("openArea");
    const openInput = document.getElementById("openInput");
    const sendOpenBtn = document.getElementById("sendOpenBtn");
    const statusEl = document.getElementById("status");

    let joined = false;
    let alreadyAnswered = false;
    let currentQuestionIndex = null;

    function formatTime(sec) {
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      return (m < 10 ? "0" + m : m) + ":" + (s < 10 ? "0" + s : s);
    }

    function doJoin(name) {
      const trimmed = (name || "").trim();
      if (!trimmed) return;

      localStorage.setItem("playerName", trimmed);
      socket.emit("joinPlayer", trimmed);

      joined = true;
      joinArea.style.display = "none";
      gameArea.style.display = "block";
      statusEl.textContent = "Connect√©, en attente du lancement‚Ä¶";
    }

    joinBtn.addEventListener("click", () => {
      doJoin(nameInput.value);
    });

    // üîÅ Quand la connexion se (re)fait, on renvoie automatiquement le pr√©nom
    socket.on("connect", () => {
      const saved = localStorage.getItem("playerName");
      if (saved) {
        nameInput.value = saved;
        doJoin(saved);
      }
    });

    socket.on("state", (state) => {
      timerEl.textContent = formatTime(state.remaining || 0);

      if (!joined) {
        // mais on met quand m√™me le timer √† jour
        return;
      }

      if (state.phase === "waiting") {
        statusEl.textContent = "En attente du d√©marrage‚Ä¶";
        optionsEl.innerHTML = "";
        openArea.style.display = "none";
        return;
      }

      if (state.phase === "pause") {
        statusEl.textContent = "‚è∏Ô∏è Pause, le quiz reprend bient√¥t‚Ä¶";
        optionsEl.innerHTML = "";
        openArea.style.display = "none";
        return;
      }

      if (state.phase === "finished") {
        statusEl.textContent = "üéâ Quiz termin√©, merci d'avoir jou√© !";
        optionsEl.innerHTML = "";
        openArea.style.display = "none";
        return;
      }

      if (state.phase === "question" && state.question) {
        if (currentQuestionIndex !== state.currentIndex) {
          currentQuestionIndex = state.currentIndex;
          alreadyAnswered = false;
          optionsEl.innerHTML = "";
          openInput.value = "";
          statusEl.textContent = "R√©ponds √† la question en regardant l'√©cran g√©ant üî•";
        }

        if (state.question.type === "mcq") {
          openArea.style.display = "none";
          optionsEl.innerHTML = "";

          state.question.options.forEach((opt, idx) => {
            const btn = document.createElement("button");
            btn.className = "opt-btn";
            btn.textContent = opt;
            btn.addEventListener("click", () => {
              if (alreadyAnswered) return;
              alreadyAnswered = true;
              socket.emit("answer", {
                questionIndex: currentQuestionIndex,
                answer: idx
              });
              statusEl.textContent = "‚úÖ R√©ponse envoy√©e !";
            });
            optionsEl.appendChild(btn);
          });
        } else {
          // question ouverte
          optionsEl.innerHTML = "";
          openArea.style.display = "block";
          sendOpenBtn.onclick = () => {
            if (alreadyAnswered) return;
            alreadyAnswered = true;
            socket.emit("answer", {
              questionIndex: currentQuestionIndex,
              answer: openInput.value
            });
            statusEl.textContent = "‚úÖ R√©ponse envoy√©e !";
          };
        }
      }
    });
  </script>
</body>
</html>
