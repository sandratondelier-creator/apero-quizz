<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Ap√©ro Quiz ‚Äì Joueur</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      background: #0f172a;
      color: white;
      font-family: system-ui;
      padding: 20px;
    }
    #card {
      max-width: 400px;
      margin: auto;
      background: #1e293b;
      padding: 20px;
      border-radius: 16px;
      border: 1px solid #334155;
    }
    #nameInput, #openInput {
      width: 100%;
      padding: 10px;
      border-radius: 12px;
      border: none;
      margin-bottom: 10px;
    }
    button {
      width: 100%;
      padding: 10px;
      border-radius: 12px;
      border: none;
      background: #3b82f6;
      color: white;
      font-size: 1rem;
      margin-bottom: 10px;
      cursor: pointer;
    }
    #timer {
      text-align: center;
      font-size: 2rem;
      margin-bottom: 10px;
    }
    #instruction {
      text-align: center;
      margin-bottom: 10px;
      color: #cbd5f5;
      font-size: 1rem;
    }
    #status {
      text-align: center;
      color: #a5b4fc;
      margin-top: 10px;
    }
    .opt-btn {
      width: 100%;
      padding: 12px;
      margin-bottom: 8px;
      border-radius: 12px;
      background: #334155;
      color: white;
      border: none;
      text-align: left;
      font-size: 1rem;
    }
    .opt-btn:active {
      background: #22c55e;
      color: black;
    }
  </style>
</head>
<body>
  <div id="card">

    <!-- INSCRIPTION -->
    <div id="joinArea">
      <h2>Rejoindre le Quiz</h2>
      <input id="nameInput" placeholder="Ton pr√©nom" />
      <button id="joinBtn">Rejoindre</button>
    </div>

    <!-- JEU -->
    <div id="gameArea" style="display:none;">
      <div id="timer">00:00</div>

      <!-- Aucun affichage de la question -->
      <div id="instruction">
        üëÄ Regarde l'√©cran g√©ant<br>
        ‚úçÔ∏è R√©ponds ici !
      </div>

      <!-- MCQ -->
      <div id="options"></div>

      <!-- R√©ponse ouverte -->
      <div id="openArea" style="display:none;">
        <input id="openInput" placeholder="Tape ta r√©ponse‚Ä¶" />
        <button id="sendOpenBtn">Envoyer</button>
      </div>

      <div id="status"></div>
    </div>

  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    const joinArea = document.getElementById("joinArea");
    const gameArea = document.getElementById("gameArea");
    const nameInput = document.getElementById("nameInput");
    const joinBtn = document.getElementById("joinBtn");

    const timerEl = document.getElementById("timer");
    const optionsEl = document.getElementById("options");
    const openArea = document.getElementById("openArea");
    const openInput = document.getElementById("openInput");
    const sendOpenBtn = document.getElementById("sendOpenBtn");
    const statusEl = document.getElementById("status");

    let joined = false;
    let alreadyAnswered = false;
    let currentQuestionIndex = null;

    function formatTime(sec) {
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      return (m < 10 ? "0" + m : m) + ":" + (s < 10 ? "0" + s : s);
    }

    joinBtn.addEventListener("click", () => {
      const name = nameInput.value.trim();
      if (!name) return alert("Entre un pr√©nom");
      socket.emit("joinPlayer", name);
      joined = true;
      joinArea.style.display = "none";
      gameArea.style.display = "block";
      statusEl.textContent = "En attente du lancement‚Ä¶";
    });

    socket.on("state", (state) => {
      timerEl.textContent = formatTime(state.remaining || 0);
      if (!joined) return;

      if (state.phase === "waiting") {
        statusEl.textContent = "En attente‚Ä¶";
        return;
      }

      if (state.phase === "pause") {
        statusEl.textContent = "Pause ‚è∏Ô∏è";
        openArea.style.display = "none";
        optionsEl.innerHTML = "";
        return;
      }

      if (state.phase === "finished") {
        statusEl.textContent = "Quiz termin√© üéâ";
        return;
      }

      if (state.phase === "question" && state.question) {
        if (currentQuestionIndex !== state.currentIndex) {
          currentQuestionIndex = state.currentIndex;
          alreadyAnswered = false;
          statusEl.textContent = "R√©ponds maintenant üéØ";
          optionsEl.innerHTML = "";
          openInput.value = "";
        }

        if (state.question.type === "mcq") {
          openArea.style.display = "none";
          optionsEl.innerHTML = "";
          state.question.options.forEach((opt, idx) => {
            const btn = document.createElement("button");
            btn.className = "opt-btn";
            btn.textContent = opt;
            btn.addEventListener("click", () => {
              if (alreadyAnswered) return;
              alreadyAnswered = true;
              socket.emit("answer", {
                questionIndex: currentQuestionIndex,
                answer: idx
              });
              statusEl.textContent = "R√©ponse envoy√©e ‚úîÔ∏è";
            });
            optionsEl.appendChild(btn);
          });
        } else {
          optionsEl.innerHTML = "";
          openArea.style.display = "block";
          sendOpenBtn.onclick = () => {
            if (alreadyAnswered) return;
            alreadyAnswered = true;
            socket.emit("answer", {
              questionIndex: currentQuestionIndex,
              answer: openInput.value
            });
            statusEl.textContent = "R√©ponse envoy√©e ‚úîÔ∏è";
          };
        }
      }
    });
  </script>
</body>
</html>
